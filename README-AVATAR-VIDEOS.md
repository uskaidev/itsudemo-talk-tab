# アバター動画機能の使い方

このドキュメントでは、OpenAIのRealtimeAPIを使用したアバターの動画表示機能について説明します。

## 概要

アバターの状態に応じて異なる動画を表示する機能が実装されています：

1. **ユーザーが話している時**：`user-talking.mp4`を表示
2. **アバターが話している時**：`avatar-talking.mp4`を表示
3. **待機状態（どちらも話していない時）**：`avatar-idle.mp4`を表示

## 動画ファイルの準備

以下の3つの動画ファイルを`/public`ディレクトリに配置してください：

1. **user-talking.mp4**：ユーザーが話している時の動画
2. **avatar-talking.mp4**：アバターが話している時の動画
3. **avatar-idle.mp4**：待機状態の動画

### 動画ファイルの仕様

- **フォーマット**：MP4（H.264コーデック）
- **解像度**：アスペクト比16:9を推奨（現在の画像と同じサイズ）
- **長さ**：5〜10秒程度（ループ再生されます）
- **音声**：なし（ミュート）

### 注意点

- 背景画像として静的画像（`/natsumi_preview.webp`）が常に表示されるため、動画ファイルが読み込まれない場合でも画面が真っ黒になることはありません
- 動画の切り替え時にはフェードエフェクトが適用され、スムーズな遷移が行われます
- 短い動画を使用することで、切り替えがより自然になります

## 技術的な実装

`OpenAIRealtimeAvatar`コンポーネントでは、以下のイベントを検知して動画を切り替えています：

- **ユーザーが話し始めた**：`input_audio_buffer.speech_started`イベント
- **ユーザーが話し終わった**：`input_audio_buffer.speech_stopped`イベント
- **アバターが話し始めた**：以下のいずれかのイベント
  - `response.text.delta`イベント
  - `output_audio_buffer.speech_started`イベント
  - `output_audio_buffer.speech_detected`イベント
- **アバターが話し終わった**：`response.done`イベント

### 改善された実装の特徴

1. **背景画像の追加**：
   - 動画の背後に静的な背景画像を配置し、動画の読み込み中や切り替え時にも背景が見えるようになっています
   - これにより、画面が真っ黒になる問題が解消されています

2. **フェードエフェクトの追加**：
   - CSSトランジションを使用して、動画の切り替え時にフェードエフェクトを適用しています
   - `transition-opacity duration-300`クラスにより、300ミリ秒かけて不透明度が変化します

3. **複数のイベントタイプの検知**：
   - アバターの発話状態をより確実に検知するため、複数のイベントタイプを監視しています
   - これにより、アバターが話している状態の検出精度が向上しています

## カスタマイズ

必要に応じて、以下の部分をカスタマイズできます：

1. **動画ファイル**：独自の動画ファイルを作成して置き換えることができます
2. **背景画像**：`<img src="/natsumi_preview.webp" ...>`の`src`属性を変更することで、背景画像を変更できます
3. **トランジション効果**：`transition-opacity duration-300`の値を変更することで、フェードの速度を調整できます
4. **z-indexの調整**：`z-0`、`z-10`、`z-20`の値を変更することで、レイヤーの重なり順を調整できます

## トラブルシューティング

動画が表示されない場合は、以下を確認してください：

1. 動画ファイルが正しい名前で`/public`ディレクトリに配置されているか
2. 動画ファイルが正しいフォーマット（MP4）であるか
3. ブラウザのコンソールにエラーメッセージが表示されていないか
4. ファイル名に余分なスペースが含まれていないか（例：`avatar-idle.mp4 .mp4`ではなく`avatar-idle.mp4`）

## 今後の改善点

- より多様な状態に対応する動画の追加（例：考え中、驚いた時など）
- 動画ファイルの設定をカスタマイズするための管理画面の追加
- プリロード機能の追加による、初回表示時のパフォーマンス向上
